#compdef claude

# Zsh completion script for Claude Code CLI
# https://github.com/anthropics/claude-code

local curcontext="$curcontext" state line
typeset -A opt_args

local -a commands
commands=(
  'mcp:Configure and manage MCP servers'
  'plugin:Manage Claude Code plugins'
  'setup-token:Set up a long-lived authentication token (requires Claude subscription)'
  'doctor:Check the health of your Claude Code auto-updater'
  'update:Check for updates and install if available'
  'install:Install Claude Code native build'
)

local -a mcp_commands
mcp_commands=(
  'serve:Start the Claude Code MCP server'
  'add:Add an MCP server to Claude Code'
  'remove:Remove an MCP server'
  'list:List configured MCP servers'
  'get:Get details about an MCP server'
  'add-json:Add an MCP server (stdio or SSE) with a JSON string'
  'add-from-claude-desktop:Import MCP servers from Claude Desktop (Mac and WSL only)'
  'reset-project-choices:Reset all approved and rejected project-scoped servers'
  'help:Display help for command'
)

local -a plugin_commands
plugin_commands=(
  'validate:Validate a plugin or marketplace manifest'
  'marketplace:Manage Claude Code marketplaces'
  'install:Install a plugin from available marketplaces'
  'i:Install a plugin from available marketplaces'
  'uninstall:Uninstall an installed plugin'
  'remove:Uninstall an installed plugin'
  'enable:Enable a disabled plugin'
  'disable:Disable an enabled plugin'
  'update:Update a plugin to the latest version'
  'help:Display help for command'
)

local -a marketplace_commands
marketplace_commands=(
  'add:Add a marketplace from a URL, path, or GitHub repo'
  'list:List all configured marketplaces'
  'remove:Remove a configured marketplace'
  'rm:Remove a configured marketplace'
  'update:Update marketplace(s) from their source'
  'help:Display help for command'
)

case $words[2] in
  mcp)
    if (( CURRENT == 3 )); then
      _describe 'mcp command' mcp_commands
    else
      case $words[3] in
        serve)
          _arguments \
            '(-d --debug)'{-d,--debug}'[Enable debug mode]' \
            '--verbose[Override verbose mode setting from config]' \
            '(-h --help)'{-h,--help}'[Display help]'
          ;;
        add)
          _arguments \
            '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local user project)' \
            '(-t --transport)'{-t,--transport}'[Transport type]:transport:(stdio sse http)' \
            '*'{-e,--env}'[Set environment variables]:env:' \
            '*'{-H,--header}'[Set WebSocket headers]:header:' \
            '(-h --help)'{-h,--help}'[Display help]' \
            ':name:' \
            ':commandOrUrl:_files' \
            '*:args:_files'
          ;;
        remove)
          _arguments \
            '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local user project)' \
            '(-h --help)'{-h,--help}'[Display help]' \
            ':name:'
          ;;
        add-json)
          _arguments \
            '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local user project)' \
            '(-h --help)'{-h,--help}'[Display help]' \
            ':name:' \
            ':json:'
          ;;
        add-from-claude-desktop)
          _arguments \
            '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local user project)' \
            '(-h --help)'{-h,--help}'[Display help]'
          ;;
        get)
          _message 'server name'
          ;;
        *)
          _message 'no more arguments'
          ;;
      esac
    fi
    return
    ;;
  plugin)
    if (( CURRENT == 3 )); then
      _describe 'plugin command' plugin_commands
    else
      case $words[3] in
        validate)
          _arguments \
            '(-h --help)'{-h,--help}'[Display help]' \
            ':path:_files'
          ;;
        marketplace)
          if (( CURRENT == 4 )); then
            _describe 'marketplace command' marketplace_commands
          else
            case $words[4] in
              add)
                _arguments \
                  '(-h --help)'{-h,--help}'[Display help]' \
                  ':source:_files'
                ;;
              remove|rm)
                _arguments \
                  '(-h --help)'{-h,--help}'[Display help]' \
                  ':name:'
                ;;
              update)
                _arguments \
                  '(-h --help)'{-h,--help}'[Display help]' \
                  ':name:'
                ;;
              *)
                _message 'no more arguments'
                ;;
            esac
          fi
          ;;
        install|i)
          _arguments \
            '(-s --scope)'{-s,--scope}'[Installation scope]:scope:(user project local)' \
            '(-h --help)'{-h,--help}'[Display help]' \
            ':plugin:'
          ;;
        uninstall|remove)
          _arguments \
            '(-s --scope)'{-s,--scope}'[Uninstall from scope]:scope:(user project local)' \
            '(-h --help)'{-h,--help}'[Display help]' \
            ':plugin:'
          ;;
        enable)
          _arguments \
            '(-s --scope)'{-s,--scope}'[Installation scope]:scope:(user project local)' \
            '(-h --help)'{-h,--help}'[Display help]' \
            ':plugin:'
          ;;
        disable)
          _arguments \
            '(-s --scope)'{-s,--scope}'[Installation scope]:scope:(user project local)' \
            '(-h --help)'{-h,--help}'[Display help]' \
            ':plugin:'
          ;;
        update)
          _arguments \
            '(-s --scope)'{-s,--scope}'[Installation scope]:scope:(user project local managed)' \
            '(-h --help)'{-h,--help}'[Display help]' \
            ':plugin:'
          ;;
        *)
          _message 'no more arguments'
          ;;
      esac
    fi
    return
    ;;
  install)
    _arguments \
      '--force[Force installation even if already installed]' \
      '(-h --help)'{-h,--help}'[Display help]' \
      ':target:(stable latest)'
    return
    ;;
  setup-token|doctor|update)
    _message 'no arguments'
    return
    ;;
esac

# Only show global flags and commands if no subcommand matched
_arguments -s \
  '(-d --debug)'{-d,--debug}'[Enable debug mode with optional category filtering]:filter:' \
  '--verbose[Override verbose mode setting from config]' \
  '(-p --print)'{-p,--print}'[Print response and exit (useful for pipes)]' \
  '--output-format[Output format]:format:(text json stream-json)' \
  '--json-schema[JSON Schema for structured output validation]:schema:' \
  '--include-partial-messages[Include partial message chunks as they arrive]' \
  '--input-format[Input format]:format:(text stream-json)' \
  '--mcp-debug[DEPRECATED - Enable MCP debug mode]' \
  '--dangerously-skip-permissions[Bypass all permission checks]' \
  '--allow-dangerously-skip-permissions[Enable bypassing all permission checks as an option]' \
  '--max-budget-usd[Maximum dollar amount to spend on API calls]:amount:' \
  '--replay-user-messages[Re-emit user messages from stdin back on stdout]' \
  '*--allowedTools[Comma or space-separated list of tool names to allow]:tools:' \
  '*--allowed-tools[Comma or space-separated list of tool names to allow]:tools:' \
  '*--tools[Specify the list of available tools from the built-in set]:tools:' \
  '*--disallowedTools[Comma or space-separated list of tool names to deny]:tools:' \
  '*--disallowed-tools[Comma or space-separated list of tool names to deny]:tools:' \
  '*--mcp-config[Load MCP servers from JSON files or strings]:config:_files' \
  '--system-prompt[System prompt to use for the session]:prompt:' \
  '--append-system-prompt[Append a system prompt to the default system prompt]:prompt:' \
  '--permission-mode[Permission mode to use for the session]:mode:(acceptEdits bypassPermissions default delegate dontAsk plan)' \
  '(-c --continue)'{-c,--continue}'[Continue the most recent conversation]' \
  '(-r --resume)'{-r,--resume}'[Resume a conversation by session ID]:value:' \
  '--fork-session[When resuming, create a new session ID instead of reusing]' \
  '--no-session-persistence[Disable session persistence]' \
  '--model[Model for the current session]:model:' \
  '--agent[Agent for the current session]:agent:' \
  '*--betas[Beta headers to include in API requests]:betas:' \
  '--fallback-model[Enable automatic fallback to specified model]:model:' \
  '--settings[Path to a settings JSON file or a JSON string]:file:_files' \
  '*--add-dir[Additional directories to allow tool access to]:dir:_files -/' \
  '--ide[Automatically connect to IDE on startup]' \
  '--strict-mcp-config[Only use MCP servers from --mcp-config]' \
  '--session-id[Use a specific session ID for the conversation]:uuid:' \
  '--agents[JSON object defining custom agents]:json:' \
  '--setting-sources[Comma-separated list of setting sources to load]:sources:' \
  '*--plugin-dir[Load plugins from directories for this session only]:dir:_files -/' \
  '--disable-slash-commands[Disable all slash commands]' \
  '--chrome[Enable Claude in Chrome integration]' \
  '--no-chrome[Disable Claude in Chrome integration]' \
  '(-v --version)'{-v,--version}'[Output the version number]' \
  '(-h --help)'{-h,--help}'[Display help for command]' \
  '1:command:(mcp plugin setup-token doctor update install)' \
  '*:prompt:'
