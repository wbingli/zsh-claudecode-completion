#compdef claude

# Zsh completion script for Claude Code CLI
# https://github.com/anthropics/claude-code

local curcontext="$curcontext" state line
typeset -A opt_args

local -a commands
commands=(
  'mcp:Configure and manage MCP servers'
  'plugin:Manage Claude Code plugins'
  'migrate-installer:Migrate from npm to local installation'
  'setup-token:Set up authentication token'
  'doctor:Check auto-updater health'
  'update:Check for and install updates'
  'install:Install Claude Code native build'
)

local -a mcp_commands
mcp_commands=(
  'serve:Start the Claude Code MCP server'
  'add:Add an MCP server'
  'remove:Remove an MCP server'
  'list:List configured MCP servers'
  'get:Get details about an MCP server'
  'add-json:Add an MCP server with JSON config'
  'add-from-claude-desktop:Import MCP servers from Claude Desktop'
  'reset-project-choices:Reset approved/rejected project servers'
)

local -a plugin_commands
plugin_commands=(
  'validate:Validate a plugin or manifest'
  'marketplace:Manage marketplaces'
  'install:Install a plugin'
  'uninstall:Uninstall a plugin'
  'enable:Enable a disabled plugin'
  'disable:Disable an enabled plugin'
)

case $words[1] in
  mcp)
    if (( CURRENT == 2 )); then
      _describe 'mcp command' mcp_commands
    else
      case $words[2] in
        add)
          _arguments \
            '(-s --scope)'{-s,--scope}'[Scope]:scope:(user project)' \
            '(-t --transport)'{-t,--transport}'[Transport]:(stdio http sse)' \
            '(-e --env)'{-e,--env}'[Environment variables]:env:' \
            '*:args:_files'
          ;;
        remove)
          _arguments \
            '(-s --scope)'{-s,--scope}'[Scope]:scope:(user project)' \
            '*:name:'
          ;;
        *)
          _message 'no more arguments'
          ;;
      esac
    fi
    return
    ;;
  plugin)
    if (( CURRENT == 2 )); then
      _describe 'plugin command' plugin_commands
    else
      case $words[2] in
        validate)
          _files
          ;;
        *)
          _message 'plugin name'
          ;;
      esac
    fi
    return
    ;;
  install)
    _arguments \
      '--force[Force installation]' \
      '1:target:(stable latest)'
    return
    ;;
  migrate-installer|setup-token|doctor|update)
    _message 'no arguments'
    return
    ;;
esac

_arguments -s \
  '(-d --debug)'{-d,--debug}'[Enable debug mode]' \
  '--verbose[Verbose mode]' \
  '(-p --print)'{-p,--print}'[Print and exit]' \
  '--output-format[Output format]:(text json stream-json)' \
  '--input-format[Input format]:(text stream-json)' \
  '--model[Model]:(sonnet opus haiku)' \
  '--fallback-model[Fallback model]:(sonnet opus haiku)' \
  '--permission-mode[Permission mode]:(default acceptEdits bypassPermissions dontAsk plan)' \
  '(-c --continue)'{-c,--continue}'[Continue conversation]' \
  '(-r --resume)'{-r,--resume}'[Resume conversation]' \
  '--fork-session[Fork session]' \
  '--settings[Settings file]:file:_files' \
  '*--add-dir[Add directory]:dir:_files -/' \
  '*--mcp-config[MCP config]:file:_files' \
  '--system-prompt[System prompt]:prompt:' \
  '--append-system-prompt[Append system prompt]:prompt:' \
  '--allowed-tools[Allowed tools]:(Bash Read Write Edit Grep Glob WebSearch WebFetch Task)' \
  '--disallowed-tools[Disallowed tools]:(Bash Read Write Edit Grep Glob WebSearch WebFetch Task)' \
  '--tools[Tools]:(Bash Read Write Edit Grep Glob WebSearch WebFetch Task)' \
  '*--plugin-dir[Plugin directory]:dir:_files -/' \
  '--dangerously-skip-permissions[Skip permissions]' \
  '--ide[Connect to IDE]' \
  '--session-id[Session ID]:uuid:' \
  '--agents[Agents JSON]:json:' \
  '--json-schema[JSON schema]:schema:' \
  '(-v --version)'{-v,--version}'[Show version]' \
  '(-h --help)'{-h,--help}'[Show help]' \
  '1:command:->cmd' \
  '*:prompt:'

if [[ $state == cmd ]]; then
  _describe 'command' commands
fi
