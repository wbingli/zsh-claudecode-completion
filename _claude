#compdef claude

# Zsh completion script for Claude Code CLI
# https://github.com/anthropics/claude-code

local curcontext="$curcontext" state line
typeset -A opt_args

local -a commands
commands=(
  'mcp:Configure and manage MCP servers'
  'plugin:Manage Claude Code plugins'
  'migrate-installer:Migrate from npm to local installation'
  'setup-token:Set up authentication token'
  'doctor:Check auto-updater health'
  'update:Check for and install updates'
  'install:Install Claude Code native build'
)

local -a mcp_commands
mcp_commands=(
  'serve:Start the Claude Code MCP server'
  'add:Add an MCP server'
  'remove:Remove an MCP server'
  'list:List configured MCP servers'
  'get:Get details about an MCP server'
  'add-json:Add an MCP server with JSON config'
  'add-from-claude-desktop:Import MCP servers from Claude Desktop'
  'reset-project-choices:Reset approved/rejected project servers'
  'help:Display help for command'
)

local -a plugin_commands
plugin_commands=(
  'validate:Validate a plugin or manifest'
  'marketplace:Manage marketplaces'
  'install:Install a plugin'
  'uninstall:Uninstall a plugin'
  'enable:Enable a disabled plugin'
  'disable:Disable an enabled plugin'
  'help:Display help for command'
)

local -a marketplace_commands
marketplace_commands=(
  'add:Add a marketplace from URL, path, or GitHub repo'
  'list:List all configured marketplaces'
  'remove:Remove a configured marketplace'
  'update:Update marketplace(s) from their source'
  'help:Display help for command'
)

case $words[2] in
  mcp)
    if (( CURRENT == 3 )); then
      _describe 'mcp command' mcp_commands
    else
      case $words[3] in
        serve)
          _arguments \
            '(-d --debug)'{-d,--debug}'[Enable debug mode]' \
            '--verbose[Override verbose mode setting from config]' \
            '(-h --help)'{-h,--help}'[Display help]'
          ;;
        add)
          _arguments \
            '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local user project)' \
            '(-t --transport)'{-t,--transport}'[Transport type]:transport:(stdio sse http)' \
            '*'{-e,--env}'[Set environment variables]:env:' \
            '*'{-H,--header}'[Set WebSocket headers]:header:' \
            '(-h --help)'{-h,--help}'[Display help]' \
            ':name:' \
            ':commandOrUrl:_files' \
            '*:args:_files'
          ;;
        remove)
          _arguments \
            '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local user project)' \
            '(-h --help)'{-h,--help}'[Display help]' \
            ':name:'
          ;;
        add-json)
          _arguments \
            '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local user project)' \
            '(-h --help)'{-h,--help}'[Display help]' \
            ':name:' \
            ':json:'
          ;;
        add-from-claude-desktop)
          _arguments \
            '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local user project)' \
            '(-h --help)'{-h,--help}'[Display help]'
          ;;
        get)
          _message 'server name'
          ;;
        *)
          _message 'no more arguments'
          ;;
      esac
    fi
    return
    ;;
  plugin)
    if (( CURRENT == 3 )); then
      _describe 'plugin command' plugin_commands
    else
      case $words[3] in
        validate)
          _arguments \
            '(-h --help)'{-h,--help}'[Display help]' \
            ':path:_files'
          ;;
        marketplace)
          if (( CURRENT == 4 )); then
            _describe 'marketplace command' marketplace_commands
          else
            case $words[4] in
              add)
                _arguments ':source:_files'
                ;;
              remove|rm)
                _message 'marketplace name'
                ;;
              update)
                _message 'marketplace name (optional)'
                ;;
              *)
                _message 'no more arguments'
                ;;
            esac
          fi
          ;;
        install|i)
          _message 'plugin name'
          ;;
        uninstall|remove)
          _message 'plugin name'
          ;;
        enable|disable)
          _message 'plugin name'
          ;;
        *)
          _message 'no more arguments'
          ;;
      esac
    fi
    return
    ;;
  install)
    _arguments \
      '--force[Force installation even if already installed]' \
      '(-h --help)'{-h,--help}'[Display help]' \
      ':target:(stable latest)'
    return
    ;;
  migrate-installer|setup-token|doctor|update)
    _message 'no arguments'
    return
    ;;
esac

# Only show global flags and commands if no subcommand matched
_arguments -s \
  '(-d --debug)'{-d,--debug}'[Enable debug mode with optional filter]:filter:' \
  '--verbose[Override verbose mode setting from config]' \
  '(-p --print)'{-p,--print}'[Print response and exit]' \
  '--output-format[Output format]:format:(text json stream-json)' \
  '--json-schema[JSON Schema for structured output]:schema:' \
  '--include-partial-messages[Include partial message chunks as they arrive]' \
  '--input-format[Input format]:format:(text stream-json)' \
  '--mcp-debug[DEPRECATED: Enable MCP debug mode]' \
  '--dangerously-skip-permissions[Bypass all permission checks]' \
  '--allow-dangerously-skip-permissions[Enable bypassing permissions as an option]' \
  '--replay-user-messages[Re-emit user messages from stdin to stdout]' \
  '*--allowedTools[Allowed tools]:tools:' \
  '*--allowed-tools[Allowed tools]:tools:' \
  '*--tools[Specify available tools from built-in set]:tools:' \
  '*--disallowedTools[Disallowed tools]:tools:' \
  '*--disallowed-tools[Disallowed tools]:tools:' \
  '*--mcp-config[Load MCP servers from JSON files or strings]:config:_files' \
  '--system-prompt[System prompt for the session]:prompt:' \
  '--append-system-prompt[Append to default system prompt]:prompt:' \
  '--permission-mode[Permission mode]:mode:(acceptEdits bypassPermissions default dontAsk plan)' \
  '(-c --continue)'{-c,--continue}'[Continue the most recent conversation]' \
  '(-r --resume)'{-r,--resume}'[Resume a conversation]:sessionId:' \
  '--fork-session[Create new session ID when resuming]' \
  '--model[Model for the session]:model:(sonnet opus haiku)' \
  '--fallback-model[Fallback model when default is overloaded]:model:(sonnet opus haiku)' \
  '--settings[Path to settings JSON file or JSON string]:file:_files' \
  '*--add-dir[Additional directories to allow tool access]:dir:_files -/' \
  '--ide[Connect to IDE on startup]' \
  '--strict-mcp-config[Only use MCP servers from --mcp-config]' \
  '--session-id[Use specific session ID]:uuid:' \
  '--agents[JSON object defining custom agents]:json:' \
  '--setting-sources[Comma-separated list of setting sources]:sources:(user project local)' \
  '*--plugin-dir[Load plugins from directories]:dir:_files -/' \
  '(-v --version)'{-v,--version}'[Output the version number]' \
  '(-h --help)'{-h,--help}'[Display help for command]' \
  '1:command:(mcp plugin migrate-installer setup-token doctor update install)' \
  '*:prompt:'
